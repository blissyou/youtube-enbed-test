<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ÏãúÏ≤≠ Î∂ÑÏÑù ÎåÄÏãúÎ≥¥Îìú</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #09090b; color: #fafafa; }
        .terminal-scroll::-webkit-scrollbar { width: 6px; }
        .terminal-scroll::-webkit-scrollbar-track { background: #18181b; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const YoutubeTracker = () => {
            const [url, setUrl] = useState('https://www.youtube.com/watch?v=aqz-KE-bpKQ');
            const [videoId, setVideoId] = useState('aqz-KE-bpKQ');
            const [player, setPlayer] = useState(null);
            const [logs, setLogs] = useState([]);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [status, setStatus] = useState('ÎåÄÍ∏∞ Ï§ë');
            const [progress, setProgress] = useState(0);
            const [isLocked, setIsLocked] = useState(false);

            const playerRef = useRef(null); 
            const intervalRef = useRef(null);
            const maxTimeRef = useRef(0);
            const isSeekingRef = useRef(false);
            const lastLogTimeRef = useRef(0); // Î°úÍ∑∏ Ï∂úÎ†• Ï†úÌïúÏö© Ref

            // Î°úÍ∑∏ Ï∂îÍ∞Ä Ìï®Ïàò
            const addLog = useCallback((message, time = null) => {
                const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false });
                const videoPos = time !== null ? time.toFixed(2) : (playerRef.current && playerRef.current.getCurrentTime ? playerRef.current.getCurrentTime().toFixed(2) : '0.00');
                
                setLogs(prev => [
                    { id: Date.now(), timestamp, message, pos: videoPos },
                    ...prev.slice(0, 99)
                ]);
            }, []);

            // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ (mm:ss)
            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return "0:00";
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s.toString().padStart(2, '0')}`;
            };

            // Ïú†ÌäúÎ∏å API Ï¥àÍ∏∞Ìôî
            useEffect(() => {
                if (window.YT && window.YT.Player) {
                    initPlayer(videoId);
                } else {
                    const tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api";
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                    window.onYouTubeIframeAPIReady = () => {
                        initPlayer(videoId);
                    };
                }

                return () => {
                    if (intervalRef.current) clearInterval(intervalRef.current);
                };
            }, []);

            const initPlayer = (id) => {
                if (playerRef.current) {
                    playerRef.current.destroy();
                }

                const origin = window.location.origin === "null" ? "*" : window.location.origin;

                playerRef.current = new window.YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: id,
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'enablejsapi': 1,
                        'origin': origin,
                        'rel': 0,
                        'modestbranding': 1
                    },
                    events: {
                        'onReady': (event) => {
                            setDuration(event.target.getDuration());
                            addLog('ÏãúÏä§ÌÖú: ÌîåÎ†àÏù¥Ïñ¥ Ï§ÄÎπÑ ÏôÑÎ£å');
                        },
                        'onStateChange': (event) => {
                            handleStateChange(event.data);
                        }
                    }
                });
                setPlayer(playerRef.current);
            };

            const handleStateChange = (state) => {
                let statusText = '';
                switch (state) {
                    case window.YT.PlayerState.PLAYING:
                        statusText = 'Ïû¨ÏÉù Ï§ë';
                        setIsPlaying(true);
                        break;
                    case window.YT.PlayerState.PAUSED:
                        statusText = 'ÏùºÏãú Ï§ëÏßÄ';
                        setIsPlaying(false);
                        break;
                    case window.YT.PlayerState.BUFFERING:
                        statusText = 'Î≤ÑÌçºÎßÅ Ï§ë';
                        break;
                    case window.YT.PlayerState.ENDED:
                        statusText = 'Ï¢ÖÎ£åÎê®';
                        setIsPlaying(false);
                        break;
                    default:
                        statusText = 'ÎåÄÍ∏∞ Ï§ë';
                }
                setStatus(statusText);
                addLog(`ÏÉÅÌÉú Î≥ÄÍ≤Ω: ${statusText}`);
            };

            // ÌÜµÌï© Ìä∏ÎûòÌÇπ Î∞è Ïû†Í∏à Î°úÏßÅ
            useEffect(() => {
                const interval = setInterval(() => {
                    const p = playerRef.current;
                    
                    // Guard: ÌîåÎ†àÏù¥Ïñ¥Í∞Ä Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÍ±∞ÎÇò API ÏÇ¨Ïö© Î∂àÍ∞Ä Ïãú Ï§ëÎã®
                    if (!p || typeof p.getCurrentTime !== 'function' || p.getPlayerState() === -1) {
                        return;
                    }

                    const cur = p.getCurrentTime();
                    const dur = p.getDuration();
                    
                    // 1. Ïû†Í∏à Î™®ÎìúÍ∞Ä ÏïÑÎãê Îïå: Ìï≠ÏÉÅ ÏµúÎåÄ ÏãúÏ†ê Í∞±Ïã† Î∞è ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                    if (!isLocked) {
                        maxTimeRef.current = cur;
                        updateState(cur, dur);
                        return;
                    }

                    // 2. Ïû†Í∏à Î™®ÎìúÏùº Îïå: ÏàòÎèô Ïù¥Îèô Ï§ëÏù¥Î©¥ Î°úÏßÅ Í±¥ÎÑàÎúÄ
                    if (isSeekingRef.current) {
                        updateState(cur, dur);
                        return;
                    }

                    // 3. Ïû†Í∏à Î™®Îìú Ï°∞Ïûë Í∞êÏßÄ: ÎØ∏ÏãúÏ≤≠ Íµ¨Í∞Ñ Ï†êÌîÑ Ïãú Ï∞®Îã®
                    if (cur > maxTimeRef.current + 1.5) {
                        p.seekTo(maxTimeRef.current, true);
                        logThrottled(`ÎØ∏ÏãúÏ≤≠ Íµ¨Í∞Ñ Ï∞®Îã®: ${formatTime(maxTimeRef.current)}ÍπåÏßÄ ÏãúÏ≤≠Ìï®`);
                    } else if (cur > maxTimeRef.current) {
                        // Ï†ïÏÉÅ Ïû¨ÏÉù Ïãú ÏµúÎåÄ ÏßÄÏ†ê Í∞±Ïã†
                        maxTimeRef.current = cur;
                    }

                    updateState(cur, dur);
                }, 100);

                return () => clearInterval(interval);
            }, [isLocked]);

            // Î≥¥Ï°∞ Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§ (Nesting Í∞êÏÜåÎ•º ÏúÑÌï¥ Î∂ÑÎ¶¨)
            const updateState = (cur, dur) => {
                setCurrentTime(cur);
                setDuration(dur);
                if (dur > 0) setProgress((cur / dur) * 100);
            };

            const logThrottled = (message) => {
                const now = Date.now();
                if (now - lastLogTimeRef.current > 1000) {
                    addLog(message);
                    lastLogTimeRef.current = now;
                }
            };

            const extractVideoId = (input) => {
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = input.match(regex);
                if (match && match[1]) return match[1];
                if (input.length === 11) return input;
                return null;
            };

            const handleLoadVideo = () => {
                const id = extractVideoId(url);
                if (id) {
                    setVideoId(id);
                    maxTimeRef.current = 0; // ÏÉà ÎπÑÎîîÏò§ Î°úÎìú Ïãú ÏãúÏ≤≠ Í∏∞Î°ù Ï¥àÍ∏∞Ìôî
                    if (player) {
                        player.loadVideoById(id);
                        addLog(`ÎπÑÎîîÏò§ ÍµêÏ≤¥: ${id}`);
                    } else {
                        initPlayer(id);
                    }
                } else {
                    alert('Ïú†Ìö®Ìïú Ïú†ÌäúÎ∏å URL ÎòêÎäî IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                }
            };

            const togglePlay = () => {
                if (!player) return;
                if (isPlaying) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                }
            };

            const handleSeek = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const pct = x / rect.width;
                const seekTo = duration * pct;

                // Ïû†Í∏à ÏÉÅÌÉúÏóêÏÑú ÎØ∏ÏãúÏ≤≠ Íµ¨Í∞Ñ(maxTime Ïù¥ÌõÑ)ÏúºÎ°ú Í∞ÄÎ†§Í≥† ÌïòÎ©¥ Ï∞®Îã®
                if (isLocked && seekTo > maxTimeRef.current + 1) {
                    addLog(`Ï∞®Îã®: ÏïÑÏßÅ Î≥¥ÏßÄ ÏïäÏùÄ Íµ¨Í∞ÑÏûÖÎãàÎã§`);
                    return;
                }

                isSeekingRef.current = true;
                player.seekTo(seekTo);
                // Îí§Î°ú Í∞ÄÎäî Í≤ΩÏö∞ maxTimeÏùÄ Ï§ÑÏù¥ÏßÄ ÏïäÏùå (Ïù¥ÎØ∏ Î≥∏ Íµ¨Í∞ÑÏúºÎ°ú Ïú†ÏßÄ)
                addLog(`ÌÉêÏÉâ Ïù¥Îèô: ${formatTime(seekTo)}`);
                setTimeout(() => { isSeekingRef.current = false; }, 500);
            };

            return (
                <div className="flex flex-col h-screen p-4 md:p-6 lg:p-8 space-y-6 max-w-7xl mx-auto">
                    {/* Header & Input Area */}
                    <header className="flex flex-col md:flex-row items-center justify-between gap-4 border-b border-zinc-800 pb-6">
                        <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                                <svg viewBox="0 0 24 24" className="w-6 h-6 fill-white">
                                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                </svg>
                            </div>
                            <h1 className="text-2xl font-bold tracking-tight text-zinc-100">Live Tracker</h1>
                        </div>
                        
                        <div className="flex flex-wrap items-center gap-4 w-full md:w-auto">
                            {/* Lock Toggle - Í∞ïÏ°∞Îêú Î≤ÑÏ†Ñ */}
                            <div className={`flex items-center space-x-3 border-2 rounded-xl px-5 py-2.5 shadow-2xl transition-all duration-300 ${isLocked ? 'bg-amber-900/30 border-amber-500 animate-pulse-slow' : 'bg-zinc-900 border-zinc-700 hover:border-zinc-500'}`}>
                                <div className="relative flex items-center">
                                    <input 
                                        type="checkbox" 
                                        id="lockTimeline"
                                        checked={isLocked}
                                        onChange={(e) => {
                                            setIsLocked(e.target.checked);
                                            if (e.target.checked && player) {
                                                maxTimeRef.current = Math.max(maxTimeRef.current, player.getCurrentTime());
                                            }
                                            addLog(`Ï†ÑÏßÑ Î∞©ÏßÄ: ${e.target.checked ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}`);
                                        }}
                                        className="w-5 h-5 rounded border-zinc-600 bg-zinc-800 text-amber-500 focus:ring-amber-500 cursor-pointer transition-transform active:scale-90"
                                    />
                                </div>
                                <label htmlFor="lockTimeline" className={`text-sm font-black cursor-pointer select-none tracking-tight ${isLocked ? 'text-amber-400' : 'text-zinc-400'}`}>
                                    {isLocked ? 'üîí Ï†ÑÏßÑ Ïä§ÌÇµ Í∏àÏßÄÎê®' : 'üîì Ï†ÑÏßÑ Î∞©ÏßÄ ÌôúÏÑ±Ìôî'}
                                </label>
                            </div>

                            <div className="flex bg-zinc-900 border border-zinc-800 rounded-xl p-1 shadow-2xl flex-1 md:flex-initial">
                                <input 
                                    type="text" 
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                    placeholder="Ïú†ÌäúÎ∏å URL ÎòêÎäî ÎπÑÎîîÏò§ ID ÏûÖÎ†•"
                                    className="bg-transparent px-4 py-2 w-full md:w-64 lg:w-80 text-zinc-300 focus:outline-none placeholder-zinc-600"
                                />
                                <button 
                                    onClick={handleLoadVideo}
                                    className="bg-zinc-100 text-zinc-950 px-6 py-2 rounded-lg font-semibold hover:bg-white transition-colors flex items-center gap-2 whitespace-nowrap"
                                >
                                    <span>Î∂àÎü¨Ïò§Í∏∞</span>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
                        {/* Left: Player & Stats */}
                        <div className="lg:col-span-8 flex flex-col space-y-4">
                            {/* Video Container */}
                            <div className="relative aspect-video bg-black rounded-2xl overflow-hidden border border-zinc-800 shadow-2xl">
                                <div id="player"></div>
                            </div>

                            {/* Controls & Status */}
                            <div className="flex flex-col md:flex-row gap-4">
                                {/* Playback Controls */}
                                <div className="bg-zinc-900 border border-zinc-800 p-2 rounded-2xl flex items-center space-x-2">
                                    <button 
                                        onClick={togglePlay}
                                        className="w-12 h-12 flex items-center justify-center rounded-xl bg-zinc-800 hover:bg-zinc-700 text-zinc-100 transition-colors"
                                    >
                                        {isPlaying ? (
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                            </svg>
                                        ) : (
                                            <svg className="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                        )}
                                    </button>
                                    <button 
                                        onClick={() => player && player.stopVideo()}
                                        className="w-12 h-12 flex items-center justify-center rounded-xl bg-zinc-800 hover:bg-zinc-700 text-zinc-100 transition-colors"
                                    >
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M6 6h12v12H6z"/>
                                        </svg>
                                    </button>
                                </div>

                                {/* Status Card */}
                                <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">ÏÉÅÌÉú</span>
                                        <div className="flex items-center mt-1">
                                            <div className={`w-2 h-2 rounded-full mr-2 ${isPlaying ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                            <p className="text-lg font-medium text-zinc-100 truncate">{status}</p>
                                        </div>
                                    </div>
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">ÌòÑÏû¨ ÏúÑÏπò</span>
                                        <p className="text-lg font-medium text-zinc-100 mt-1 font-mono tracking-tighter">
                                            {formatTime(currentTime)}
                                        </p>
                                    </div>
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">Ï†ÑÏ≤¥ Í∏∏Ïù¥</span>
                                        <p className="text-lg font-medium text-zinc-100 mt-1 font-mono tracking-tighter">
                                            {formatTime(duration)}
                                        </p>
                                    </div>
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">ÏßÑÌñâÎ•†</span>
                                        <p className="text-lg font-medium text-zinc-100 mt-1">{progress.toFixed(1)}%</p>
                                    </div>
                                </div>
                            </div>

                            {/* Progress Bar */}
                            <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl space-y-3">
                                <div className="flex justify-between text-xs text-zinc-500 font-bold uppercase tracking-widest">
                                    <span>Playback Progress {isLocked && <span className="text-amber-500 ml-2">(SKIP LOCK ACTIVE)</span>}</span>
                                    <span>{formatTime(currentTime)} / {formatTime(duration)}</span>
                                </div>
                                <div 
                                    className={`w-full bg-zinc-800 rounded-full h-4 overflow-hidden border border-zinc-700 p-[1px] relative ${isLocked ? 'cursor-pointer hover:border-amber-900' : 'cursor-pointer hover:border-zinc-500'}`}
                                    onClick={handleSeek}
                                >
                                    {/* Watched Range (Max) */}
                                    <div 
                                        className="absolute top-0 left-0 h-full bg-zinc-700/50"
                                        style={{ width: `${(maxTimeRef.current / duration) * 100}%` }}
                                    ></div>
                                    {/* Current Progress */}
                                    <div 
                                        className={`h-full rounded-full transition-all duration-100 ease-linear shadow-[0_0_12px_rgba(255,255,255,0.3)] relative z-10 ${isLocked ? 'bg-amber-500' : 'bg-zinc-100'}`}
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>
                                <div className="flex justify-between text-[10px] text-zinc-600 font-bold uppercase">
                                    <span>0:00</span>
                                    <span>{isLocked ? 'Ïù¥ÎØ∏ ÏãúÏ≤≠Ìïú Íµ¨Í∞ÑÍπåÏßÄÎßå ÏûêÏú† Ïù¥ÎèôÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§' : 'ÏûêÏú†Î°úÏö¥ ÌÉêÏÉâÏù¥ Í∞ÄÎä•Ìï©ÎãàÎã§'}</span>
                                    <span>{formatTime(duration)}</span>
                                </div>
                            </div>
                        </div>

                        {/* Right: Event Feed */}
                        <div className="lg:col-span-4 flex flex-col min-h-[400px] lg:min-h-0 bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden shadow-2xl">
                            <div className="p-4 border-b border-zinc-800 bg-zinc-900/50 backdrop-blur flex justify-between items-center">
                                <div className="flex items-center space-x-2">
                                    <div className="w-3 h-3 rounded-full bg-zinc-700"></div>
                                    <h3 className="font-bold text-sm uppercase tracking-widest text-zinc-400">Live Event Feed</h3>
                                </div>
                                <button 
                                    onClick={() => setLogs([])}
                                    className="text-[10px] bg-zinc-800 hover:bg-zinc-700 text-zinc-400 px-2 py-1 rounded transition-colors uppercase font-bold"
                                >
                                    Clear
                                </button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto terminal-scroll p-4 font-mono text-sm space-y-3">
                                {logs.length === 0 ? (
                                    <div className="text-zinc-600 flex flex-col items-center justify-center h-full space-y-2 opacity-50">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span>Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§</span>
                                    </div>
                                ) : (
                                    logs.map(log => (
                                        <div key={log.id} className="border-l-2 border-zinc-700 pl-3 py-1 group hover:bg-zinc-800/50 rounded-r transition-all">
                                            <div className="flex justify-between items-start">
                                                <span className="text-zinc-500 text-xs">[{log.timestamp}]</span>
                                                <span className="text-zinc-400 text-xs bg-zinc-800 px-1.5 rounded font-bold">{log.pos}s</span>
                                            </div>
                                            <p className="text-zinc-200 mt-1 leading-relaxed">{log.message}</p>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="text-center py-4 text-zinc-600 text-xs font-medium uppercase tracking-widest">
                        YouTube Realtime Tracker ¬© 2026 ‚Ä¢ Build with React & Tailwind
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<YoutubeTracker />);
    </script>
</body>
</html>
