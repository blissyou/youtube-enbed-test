<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube 시청 분석 대시보드</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #09090b; color: #fafafa; }
        .terminal-scroll::-webkit-scrollbar { width: 6px; }
        .terminal-scroll::-webkit-scrollbar-track { background: #18181b; }
        .terminal-scroll::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const YoutubeTracker = () => {
            const [url, setUrl] = useState('https://www.youtube.com/watch?v=aqz-KE-bpKQ');
            const [videoId, setVideoId] = useState('aqz-KE-bpKQ');
            const [player, setPlayer] = useState(null);
            const [logs, setLogs] = useState([]);
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            const [status, setStatus] = useState('대기 중');
            const [progress, setProgress] = useState(0);
            const [isLocked, setIsLocked] = useState(false);

            const playerRef = useRef(null); 
            const intervalRef = useRef(null);
            const maxTimeRef = useRef(0); // 시청 완료한 최대 지점 (기준점)
            const isSeekingRef = useRef(false);

            // 로그 추가 함수
            const addLog = useCallback((message, time = null) => {
                const timestamp = new Date().toLocaleTimeString('ko-KR', { hour12: false });
                const videoPos = time !== null ? time.toFixed(2) : (playerRef.current && playerRef.current.getCurrentTime ? playerRef.current.getCurrentTime().toFixed(2) : '0.00');
                
                setLogs(prev => [
                    { id: Date.now(), timestamp, message, pos: videoPos },
                    ...prev.slice(0, 99)
                ]);
            }, []);

            // 시간 포맷팅 (mm:ss)
            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return "0:00";
                const m = Math.floor(seconds / 60);
                const s = Math.floor(seconds % 60);
                return `${m}:${s.toString().padStart(2, '0')}`;
            };

            // 유튜브 API 초기화
            useEffect(() => {
                if (window.YT && window.YT.Player) {
                    initPlayer(videoId);
                } else {
                    const tag = document.createElement('script');
                    tag.src = "https://www.youtube.com/iframe_api";
                    const firstScriptTag = document.getElementsByTagName('script')[0];
                    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

                    window.onYouTubeIframeAPIReady = () => {
                        initPlayer(videoId);
                    };
                }

                return () => {
                    if (intervalRef.current) clearInterval(intervalRef.current);
                };
            }, []);

            const initPlayer = (id) => {
                if (playerRef.current) {
                    playerRef.current.destroy();
                }

                const origin = window.location.origin === "null" ? "*" : window.location.origin;

                playerRef.current = new window.YT.Player('player', {
                    height: '100%',
                    width: '100%',
                    videoId: id,
                    playerVars: {
                        'autoplay': 0,
                        'controls': 1,
                        'enablejsapi': 1,
                        'origin': origin,
                        'rel': 0,
                        'modestbranding': 1
                    },
                    events: {
                        'onReady': (event) => {
                            setDuration(event.target.getDuration());
                            addLog('시스템: 플레이어 준비 완료');
                        },
                        'onStateChange': (event) => {
                            handleStateChange(event.data);
                        }
                    }
                });
                setPlayer(playerRef.current);
            };

            const handleStateChange = (state) => {
                let statusText = '';
                switch (state) {
                    case window.YT.PlayerState.PLAYING:
                        statusText = '재생 중';
                        setIsPlaying(true);
                        break;
                    case window.YT.PlayerState.PAUSED:
                        statusText = '일시 중지';
                        setIsPlaying(false);
                        break;
                    case window.YT.PlayerState.BUFFERING:
                        statusText = '버퍼링 중';
                        break;
                    case window.YT.PlayerState.ENDED:
                        statusText = '종료됨';
                        setIsPlaying(false);
                        break;
                    default:
                        statusText = '대기 중';
                }
                setStatus(statusText);
                addLog(`상태 변경: ${statusText}`);
            };

            // 통합 트래킹 및 잠금 로직
            useEffect(() => {
                const interval = setInterval(() => {
                    const p = playerRef.current;
                    if (p && typeof p.getCurrentTime === 'function' && p.getPlayerState() !== -1) {
                        const cur = p.getCurrentTime();
                        const dur = p.getDuration();
                        
                        // 전진 방지 핵심 로직 (시청 완료 구간 내 이동은 허용)
                        if (isLocked && !isSeekingRef.current) {
                            // 현재 위치가 기록된 최대 시청 지점보다 1.5초 이상 앞서면 (미시청 구간 점프)
                            if (cur > maxTimeRef.current + 1.5) {
                                p.seekTo(maxTimeRef.current, true);
                                if (!window._lastLogTime || Date.now() - window._lastLogTime > 1000) {
                                    addLog(`미시청 구간 차단: ${formatTime(maxTimeRef.current)}까지 시청함`);
                                    window._lastLogTime = Date.now();
                                }
                            } else {
                                // 정상 재생 중이거나 시청 완료 구간 내에서의 이동이면 maxTime 업데이트
                                if (cur > maxTimeRef.current) {
                                    maxTimeRef.current = cur;
                                }
                            }
                        } else if (!isLocked) {
                            // 잠금이 아닐 때는 항상 현재 위치를 최대 시점으로 업데이트
                            maxTimeRef.current = cur;
                        }

                        setCurrentTime(cur);
                        setDuration(dur);
                        if (dur > 0) {
                            setProgress((cur / dur) * 100);
                        }
                    }
                }, 100);

                return () => clearInterval(interval);
            }, [isLocked]); 

            const extractVideoId = (input) => {
                const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = input.match(regex);
                if (match && match[1]) return match[1];
                if (input.length === 11) return input;
                return null;
            };

            const handleLoadVideo = () => {
                const id = extractVideoId(url);
                if (id) {
                    setVideoId(id);
                    maxTimeRef.current = 0; // 새 비디오 로드 시 시청 기록 초기화
                    if (player) {
                        player.loadVideoById(id);
                        addLog(`비디오 교체: ${id}`);
                    } else {
                        initPlayer(id);
                    }
                } else {
                    alert('유효한 유튜브 URL 또는 ID를 입력하세요.');
                }
            };

            const togglePlay = () => {
                if (!player) return;
                if (isPlaying) {
                    player.pauseVideo();
                } else {
                    player.playVideo();
                }
            };

            const handleSeek = (e) => {
                const rect = e.currentTarget.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const pct = x / rect.width;
                const seekTo = duration * pct;

                // 잠금 상태에서 미시청 구간(maxTime 이후)으로 가려고 하면 차단
                if (isLocked && seekTo > maxTimeRef.current + 1) {
                    addLog(`차단: 아직 보지 않은 구간입니다`);
                    return;
                }

                isSeekingRef.current = true;
                player.seekTo(seekTo);
                // 뒤로 가는 경우 maxTime은 줄이지 않음 (이미 본 구간으로 유지)
                addLog(`탐색 이동: ${formatTime(seekTo)}`);
                setTimeout(() => { isSeekingRef.current = false; }, 500);
            };

            return (
                <div className="flex flex-col h-screen p-4 md:p-6 lg:p-8 space-y-6 max-w-7xl mx-auto">
                    {/* Header & Input Area */}
                    <header className="flex flex-col md:flex-row items-center justify-between gap-4 border-b border-zinc-800 pb-6">
                        <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 bg-red-600 rounded-lg flex items-center justify-center">
                                <svg viewBox="0 0 24 24" className="w-6 h-6 fill-white">
                                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                </svg>
                            </div>
                            <h1 className="text-2xl font-bold tracking-tight text-zinc-100">Live Tracker</h1>
                        </div>
                        
                        <div className="flex flex-wrap items-center gap-4 w-full md:w-auto">
                            {/* Lock Toggle */}
                            <div className={`flex items-center space-x-2 border rounded-xl px-4 py-2 shadow-2xl transition-colors ${isLocked ? 'bg-amber-950/20 border-amber-900/50' : 'bg-zinc-900 border-zinc-800'}`}>
                                <input 
                                    type="checkbox" 
                                    id="lockTimeline"
                                    checked={isLocked}
                                    onChange={(e) => {
                                        setIsLocked(e.target.checked);
                                        if (e.target.checked && player) {
                                            // 잠금 활성화 시 현재 재생 시점을 최대 시청 지점으로 설정
                                            maxTimeRef.current = Math.max(maxTimeRef.current, player.getCurrentTime());
                                        }
                                        addLog(`시청 구간 잠금: ${e.target.checked ? '활성화' : '비활성화'}`);
                                    }}
                                    className="w-4 h-4 rounded border-zinc-700 bg-zinc-800 text-amber-600 focus:ring-amber-500 focus:ring-offset-zinc-900 cursor-pointer"
                                />
                                <label htmlFor="lockTimeline" className={`text-sm font-bold cursor-pointer select-none ${isLocked ? 'text-amber-400' : 'text-zinc-300'}`}>
                                    {isLocked ? '미시청 구간 스킵 금지' : '전진 방지 활성화'}
                                </label>
                            </div>

                            <div className="flex bg-zinc-900 border border-zinc-800 rounded-xl p-1 shadow-2xl flex-1 md:flex-initial">
                                <input 
                                    type="text" 
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                    placeholder="유튜브 URL 또는 비디오 ID 입력"
                                    className="bg-transparent px-4 py-2 w-full md:w-64 lg:w-80 text-zinc-300 focus:outline-none placeholder-zinc-600"
                                />
                                <button 
                                    onClick={handleLoadVideo}
                                    className="bg-zinc-100 text-zinc-950 px-6 py-2 rounded-lg font-semibold hover:bg-white transition-colors flex items-center gap-2 whitespace-nowrap"
                                >
                                    <span>불러오기</span>
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-0">
                        {/* Left: Player & Stats */}
                        <div className="lg:col-span-8 flex flex-col space-y-4">
                            {/* Video Container */}
                            <div className="relative aspect-video bg-black rounded-2xl overflow-hidden border border-zinc-800 shadow-2xl">
                                <div id="player"></div>
                            </div>

                            {/* Controls & Status */}
                            <div className="flex flex-col md:flex-row gap-4">
                                {/* Playback Controls */}
                                <div className="bg-zinc-900 border border-zinc-800 p-2 rounded-2xl flex items-center space-x-2">
                                    <button 
                                        onClick={togglePlay}
                                        className="w-12 h-12 flex items-center justify-center rounded-xl bg-zinc-800 hover:bg-zinc-700 text-zinc-100 transition-colors"
                                    >
                                        {isPlaying ? (
                                            <svg className="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                            </svg>
                                        ) : (
                                            <svg className="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M8 5v14l11-7z"/>
                                            </svg>
                                        )}
                                    </button>
                                    <button 
                                        onClick={() => player && player.stopVideo()}
                                        className="w-12 h-12 flex items-center justify-center rounded-xl bg-zinc-800 hover:bg-zinc-700 text-zinc-100 transition-colors"
                                    >
                                        <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M6 6h12v12H6z"/>
                                        </svg>
                                    </button>
                                </div>

                                {/* Status Card */}
                                <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">상태</span>
                                        <div className="flex items-center mt-1">
                                            <div className={`w-2 h-2 rounded-full mr-2 ${isPlaying ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                            <p className="text-lg font-medium text-zinc-100 truncate">{status}</p>
                                        </div>
                                    </div>
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">현재 위치</span>
                                        <p className="text-lg font-medium text-zinc-100 mt-1 font-mono tracking-tighter">
                                            {formatTime(currentTime)}
                                        </p>
                                    </div>
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">전체 길이</span>
                                        <p className="text-lg font-medium text-zinc-100 mt-1 font-mono tracking-tighter">
                                            {formatTime(duration)}
                                        </p>
                                    </div>
                                    <div className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl">
                                        <span className="text-xs text-zinc-500 uppercase font-bold tracking-widest text-[10px]">진행률</span>
                                        <p className="text-lg font-medium text-zinc-100 mt-1">{progress.toFixed(1)}%</p>
                                    </div>
                                </div>
                            </div>

                            {/* Progress Bar */}
                            <div className="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl space-y-3">
                                <div className="flex justify-between text-xs text-zinc-500 font-bold uppercase tracking-widest">
                                    <span>Playback Progress {isLocked && <span className="text-amber-500 ml-2">(SKIP LOCK ACTIVE)</span>}</span>
                                    <span>{formatTime(currentTime)} / {formatTime(duration)}</span>
                                </div>
                                <div 
                                    className={`w-full bg-zinc-800 rounded-full h-4 overflow-hidden border border-zinc-700 p-[1px] relative ${isLocked ? 'cursor-pointer hover:border-amber-900' : 'cursor-pointer hover:border-zinc-500'}`}
                                    onClick={handleSeek}
                                >
                                    {/* Watched Range (Max) */}
                                    <div 
                                        className="absolute top-0 left-0 h-full bg-zinc-700/50"
                                        style={{ width: `${(maxTimeRef.current / duration) * 100}%` }}
                                    ></div>
                                    {/* Current Progress */}
                                    <div 
                                        className={`h-full rounded-full transition-all duration-100 ease-linear shadow-[0_0_12px_rgba(255,255,255,0.3)] relative z-10 ${isLocked ? 'bg-amber-500' : 'bg-zinc-100'}`}
                                        style={{ width: `${progress}%` }}
                                    ></div>
                                </div>
                                <div className="flex justify-between text-[10px] text-zinc-600 font-bold uppercase">
                                    <span>0:00</span>
                                    <span>{isLocked ? '이미 시청한 구간까지만 자유 이동이 가능합니다' : '자유로운 탐색이 가능합니다'}</span>
                                    <span>{formatTime(duration)}</span>
                                </div>
                            </div>
                        </div>

                        {/* Right: Event Feed */}
                        <div className="lg:col-span-4 flex flex-col min-h-[400px] lg:min-h-0 bg-zinc-900 border border-zinc-800 rounded-2xl overflow-hidden shadow-2xl">
                            <div className="p-4 border-b border-zinc-800 bg-zinc-900/50 backdrop-blur flex justify-between items-center">
                                <div className="flex items-center space-x-2">
                                    <div className="w-3 h-3 rounded-full bg-zinc-700"></div>
                                    <h3 className="font-bold text-sm uppercase tracking-widest text-zinc-400">Live Event Feed</h3>
                                </div>
                                <button 
                                    onClick={() => setLogs([])}
                                    className="text-[10px] bg-zinc-800 hover:bg-zinc-700 text-zinc-400 px-2 py-1 rounded transition-colors uppercase font-bold"
                                >
                                    Clear
                                </button>
                            </div>
                            
                            <div className="flex-1 overflow-y-auto terminal-scroll p-4 font-mono text-sm space-y-3">
                                {logs.length === 0 ? (
                                    <div className="text-zinc-600 flex flex-col items-center justify-center h-full space-y-2 opacity-50">
                                        <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1.5" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        <span>로그가 없습니다</span>
                                    </div>
                                ) : (
                                    logs.map(log => (
                                        <div key={log.id} className="border-l-2 border-zinc-700 pl-3 py-1 group hover:bg-zinc-800/50 rounded-r transition-all">
                                            <div className="flex justify-between items-start">
                                                <span className="text-zinc-500 text-xs">[{log.timestamp}]</span>
                                                <span className="text-zinc-400 text-xs bg-zinc-800 px-1.5 rounded font-bold">{log.pos}s</span>
                                            </div>
                                            <p className="text-zinc-200 mt-1 leading-relaxed">{log.message}</p>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <footer className="text-center py-4 text-zinc-600 text-xs font-medium uppercase tracking-widest">
                        YouTube Realtime Tracker © 2026 • Build with React & Tailwind
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<YoutubeTracker />);
    </script>
</body>
</html>
